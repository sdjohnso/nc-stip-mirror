name: Update NC STIP Mirror

on:
  schedule:
    # Daily at 6 AM EST (11:00 UTC) - Active construction only
    - cron: '0 11 * * *'
    # Weekly on Sunday at 7 AM EST (12:00 UTC) - STIP + ProgLoc + construction
    - cron: '0 12 * * 0'
    # Monthly on 1st at 8 AM EST (13:00 UTC) - All data
    - cron: '0 13 1 * *'

  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type to run'
        required: true
        default: 'full'
        type: choice
        options:
          - daily
          - weekly
          - monthly
          - full

jobs:
  update-mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate git operations
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine update type
        id: update-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.update_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 11 * * *" ]; then
            echo "type=daily" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 12 * * 0" ]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 13 1 * *" ]; then
            echo "type=monthly" >> $GITHUB_OUTPUT
          else
            echo "type=full" >> $GITHUB_OUTPUT
          fi

      - name: Run mirror update
        run: |
          echo "Running ${{ steps.update-type.outputs.type }} update"
          python scripts/update_mirror.py ${{ steps.update-type.outputs.type }}

      - name: Check for changes
        id: git-check
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git diff --staged --stat
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          UPDATE_TYPE="${{ steps.update-type.outputs.type }}"

          git commit -m "Mirror update: ${UPDATE_TYPE} - ${TIMESTAMP}"
          git push

      - name: Summary
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type:** ${{ steps.update-type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected:** ${{ steps.git-check.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f LAST_UPDATED.md ]; then
            echo "### Mirror Status" >> $GITHUB_STEP_SUMMARY
            head -20 LAST_UPDATED.md >> $GITHUB_STEP_SUMMARY
          fi
